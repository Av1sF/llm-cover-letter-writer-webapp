<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
</head>

<body>
    {{username}}
    {{email}}
    <br>
    <br> 
    Update your profile! 
    <form id="updateUserInfo">
        <input type="username" name="username" value="{{username}}">
        <br>
        <br>
        <input type="email" name="email" value="{{email}}">
        <br>
        <br>
        <input type="submit" value="Update"> 
    </form>
    {{updateMsg if updateMsg}}
    Once deleted you will be redirected to the registeration page 
    <button id = 'deleteUser'>DELETE PROFILE</button>
    <p id="deleteMsg"></p>
    {{deleteMsg if deleteMsg}}
</body>
<script>
    const updateForm = document.querySelector("#updateUserInfo")
    const deletebtn = document.getElementById("deleteUser")
    const deleteMsg = document.getElementById("deleteMsg")
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    async function sendData() {
        const formData = new FormData(updateForm)
        try {
            const response = await fetch("{{url_for('user.updateProfile')}}", {
                method:"PUT",
                headers: {
                "X-CSRF-TOKEN": getCookie("csrf_access_token"),
                },
                body: formData, 
            });
            console.log(await response.json());
        } catch (e) {
            console.error(e); 
        }

    }

    function deleteRequest() {
        try{
            fetch("{{url_for('user.deleteProfile')}}", {
                method:"DELETE",
                redirect:"follow",
                headers: {"X-CSRF-TOKEN": getCookie("csrf_access_token")}
            }).then(response=>response.text())
            .then((text) => {
                if (text == "Success") {
                    fetch("{{url_for('user_authentication.unsetTokenLogout')}}", {
                        method:"POST",
                        redirect:"follow",
                        headers: {"X-CSRF-TOKEN": getCookie("csrf_access_token")}
                    }).then(function(response) {
                        if (response.redirected) {
                            window.location.href = response.url 
                        }
                    })
                } else {
                    console.log(text)
                }
            })
        } catch (e) {
            console.error(e);
        }
        // try {
        //     fetch("{{url_for('user.deleteProfile')}}", {
        //         method:"DELETE",
        //         redire)ct:"follow",
        //         headers: {"X-CSRF-TOKEN": getCookie("csrf_access_token")}
        //     }).then(function(response) {
        //         // console.log(response)
        //         if (response.redirected) {
        //             fetch("{{url_for('user_authentication.unsetTokenLogout')}}", {
        //                 method:"POST",
        //                 redirect:"follow",
        //                 headers:{"X-CSRF-TOKEN": getCookie("csrf_access_token")}
        //             }).then(function(response) {

        //             })
        //             window.location.href = response.url 
        //         } else {
        //             response = response.text().then((text) => {
        //                 console.log(text)
        //             })
        //         }
        //     })
        // } catch (e) {
        //     console.error(e); 
        // }
    }

    updateForm.addEventListener("submit", (event) => {
        event.preventDefault();
        sendData();
    })

    deletebtn.addEventListener("click", deleteRequest)



</script>
</html>